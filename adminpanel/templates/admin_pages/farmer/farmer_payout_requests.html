{% extends 'components/base.html' %}
{% load static %}

{% block content %}
<div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
  <div>
    <h1 class="text-2xl font-semibold text-gray-800 mb-2 flex items-center gap-2">
      <i class="fas fa-money-bill-wave text-green-600"></i>
      Farmer Payout Requests
    </h1>
    <p class="text-sm text-gray-500">Review and process pending payout requests from farmers</p>
  </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <!-- Total Pending -->
  <div class="card bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-600 mb-1">Total Pending</p>
        <h3 class="text-2xl font-bold text-yellow-700">{{ total_requests }}</h3>
      </div>
      <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center">
        <i class="fas fa-clock text-white text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Total Amount -->
  <div class="card bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-600 mb-1">Total Amount</p>
        <h3 class="text-xl font-bold text-blue-700">
          Rs. {{total_pending_amount|default:0|floatformat:2}}
     
        </h3>
      </div>
      <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
        <i class="fas fa-coins text-white text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Total Approved  -->
  <div class="card bg-gradient-to-br from-green-50 to-green-100 border-green-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-600 mb-1">Total Approved </p>
        <h3 class="text-2xl font-bold text-green-700">{{ total_approved_requests|default:0 }}</h3>
      </div>
      <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
        <i class="fas fa-check-circle text-white text-xl"></i>
      </div>
    </div>
  </div>

<!-- Total Rejected -->
    <div class="card bg-gradient-to-br from-red-50 to-red-100 border-red-200">
        <div class="flex items-center justify-between">
        <div>
            <p class="text-sm text-gray-600 mb-1">Total Rejected </p>
            <h3 class="text-2xl font-bold text-red-700">{{ total_rejected_requests|default:0 }}</h3>
        </div>
        <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center">
            <i class="fas fa-times-circle text-white text-xl"></i>
        </div>
        </div>
    </div>


</div>

<!-- Filter Card -->
<div class="card mb-4">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
   
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Province</label>
      <select id="provinceFilter" class="form-control">
        <option value="">All Provinces</option>
        <option value="Koshi Province">Koshi Province</option>
        <option value="Madhesh Province">Madhesh Province</option>
        <option value="Bagmati Province">Bagmati Province</option>
        <option value="Gandaki Province">Gandaki Province</option>
        <option value="Lumbini Province">Lumbini Province</option>
        <option value="Karnali Province">Karnali Province</option>
        <option value="Sudurpashchim Province">Sudurpashchim Province</option>
      </select>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Amount Range</label>
      <select id="amountFilter" class="form-control">
        <option value="">All Amounts</option>
        <option value="0-5000">Rs. 0 - 5,000</option>
        <option value="5000-10000">Rs. 5,000 - 10,000</option>
        <option value="10000-50000">Rs. 10,000 - 50,000</option>
        <option value="50000+">Rs. 50,000+</option>
      </select>
    </div>
    <div class="flex items-end">
      <button id="resetBtn" class="btn btn-primary w-full">
        <i class="fas fa-redo"></i>
        Reset Filters
      </button>
    </div>
  </div>
</div>

<!-- Payout Requests Table -->
<div class="card">
  <div class="overflow-x-auto">
    <table id="payoutTable" class="table">
      <thead>
        <tr>
          <th>Request ID</th>
          <th>Farm Details</th>
          <th>Farmer Info</th>
          <th>Location</th>
          <th>Wallet Balance</th>
          <th>Requested Amount</th>
          <th>Payment QR</th>
          <th>Requested Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for request in payout_requests %}
        <tr class="payout-row-{{ request.id }}" data-request-id="{{ request.id }}" data-amount="{{ request.requested_amount }}">
          <td class="font-medium text-primary">#{{ request.id }}</td>
          
          <!-- Farm Details -->
          <td>
            <div class="font-medium">{{ request.farmer.farm_name }}</div>
            <div class="text-xs text-gray-500">PAN: {{ request.farmer.pan_number }}</div>
          </td>
          
          <!-- Farmer Info -->
          <td>
            <div class="font-medium">{{ request.farmer.user.get_full_name|default:request.farmer.user.username }}</div>
            <div class="text-xs text-gray-500">{{ request.farmer.user.email }}</div>
            <div class="text-xs text-gray-400">{{ request.farmer.phone }}</div>
          </td>
          
          <!-- Location -->
          <td>
            <div>{{ request.farmer.city }}</div>
            <div class="text-xs text-gray-500">{{ request.farmer.get_province_display }}</div>
          </td>
          
          <!-- Wallet Balance -->
          <td>
            <div class="font-semibold text-green-600">Rs. {{ request.farmer.farmer_wallet.balance|floatformat:2 }}</div>
            {% if request.farmer.farmer_wallet.balance < request.requested_amount %}
            <div class="text-xs text-red-500">
              <i class="fas fa-exclamation-triangle"></i> Insufficient
            </div>
            {% endif %}
          </td>
          
          <!-- Requested Amount -->
          <td>
            <div class="font-bold text-lg text-blue-600">Rs. {{ request.requested_amount|floatformat:2 }}</div>
          </td>
          
          <!-- Payment QR -->
        <td>
  {% if request.farmer.qr_image %}
    <a href="{{ request.farmer.qr_image.url }}" target="_blank" 
       class="text-blue-600 hover:underline text-sm">
      <i class="fas fa-qrcode"></i> View QR
    </a>
  {% else %}
    <span class="text-xs text-gray-400 italic">No QR</span>
  {% endif %}
</td>

          
          <!-- Requested Date -->
          <td>
            <div>{{ request.created_at|date:"M d, Y" }}</div>
            <div class="text-xs text-gray-500">{{ request.created_at|time:"h:i A" }}</div>
            <div class="text-xs text-gray-400 mt-1">{{ request.created_at|timesince }} ago</div>
          </td>
          
          <!-- Status -->
          <td class="status-cell-{{ request.id }}">
            <div class="flex flex-col gap-2">
              <span class="badge badge-warning w-fit">
                <i class="fas fa-clock"></i>
                {{ request.get_status_display }}
              </span>
              <select class="form-control text-xs status-select" data-request-id="{{ request.id }}" data-farmer-name="{{ request.farmer.farm_name }}" data-amount="{{ request.requested_amount }}" style="min-width: 120px;">
                <option value="">Change Status</option>
                <option value="approved">Approve</option>
                <option value="rejected">Reject</option>
                <option value="paid">Mark as Paid</option>
              </select>
            </div>
          </td>
          
          <!-- Actions -->
          <td>
            <div class="flex flex-col gap-2">
              <button class="btn btn-success  px-3 btn-sm approve-btn" data-request-id="{{ request.id }}" data-farmer-name="{{ request.farmer.farm_name }}" data-amount="{{ request.requested_amount }}" title="Approve">
                <i class="fas fa-check"></i>
                Approve
              </button>
              <button class="btn btn-danger px-3 btn-sm reject-btn" data-request-id="{{ request.id }}" data-farmer-name="{{ request.farmer.farm_name }}" title="Reject">
                <i class="fas fa-times"></i>
                Reject
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center text-gray-500 py-8">
            <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
            <p class="font-medium">No pending payout requests</p>
            <p class="text-xs mt-1">All requests have been processed!</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- QR Code Modal -->
<div id="qrModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full overflow-hidden">
    <!-- Modal Header -->
    <div class="flex items-center justify-between p-4 sm:p-6 border-b bg-gradient-to-r from-green-50 to-blue-50">
      <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Payment QR Code</h3>
      <button onclick="closeQRModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    
    <!-- Modal Content -->
    <div class="p-4 sm:p-6" id="qrContent">
      <!-- Content will be loaded here -->
    </div>
    
    <!-- Modal Footer -->
    <div class="flex justify-end gap-3 p-4 sm:p-6 border-t bg-gray-50">
      <button onclick="closeQRModal()" class="btn btn-secondary">
        <i class="fas fa-times"></i> Close
      </button>
      <button id="qrApproveBtn" class="btn btn-success">
        <i class="fas fa-check"></i> Approve & Process Payment
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');


// Update Status Display
function updateStatusDisplay(requestId, status) {
  const badges = {
    'approved': 'badge-success',
    'rejected': 'badge-danger',
    'paid': 'badge-info',
    'pending': 'badge-warning'
  };
  
  const icons = {
    'approved': 'fa-check-circle',
    'rejected': 'fa-times-circle',
    'paid': 'fa-money-bill-wave',
    'pending': 'fa-clock'
  };
  
  const displayText = {
    'approved': 'Approved',
    'rejected': 'Rejected',
    'paid': 'Paid',
    'pending': 'Pending'
  };

  const $statusCell = $(`.status-cell-${requestId}`);
  const $badge = $statusCell.find('.badge');
  $badge.removeClass('badge-success badge-danger badge-warning badge-info').addClass(badges[status]);
  $badge.html(`<i class="fas ${icons[status]}"></i> ${displayText[status]}`);

  const $select = $statusCell.find('.status-select');
  $select.val('');
}

// Change Payout Status API Call
function changePayoutStatus(requestId, newStatus, farmerName, adminResponse = '') {
  Swal.fire({
    title: 'Processing...',
    allowOutsideClick: false,
    didOpen: () => { Swal.showLoading(); }
  });

  axios.post("{% url 'admin_farmer_payout_status_change_api' %}", {
    payout_id: requestId,
    new_status: newStatus,
    admin_response: adminResponse
  }, {
    headers: {
      'X-CSRFToken': csrftoken
    }
  })
  .then(function(response) {
    const data = response.data;
    
    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        html: `Payout request for <strong>${farmerName}</strong> has been ${newStatus}!`,
        timer: 2000,
        showConfirmButton: false
      }).then(() => {
        // Remove row from table
        $(`.payout-row-${requestId}`).fadeOut(300, function() {
          $(this).remove();
          
          // Update count
          const currentCount = parseInt($('.text-yellow-700').first().text());
          if (currentCount > 0) {
            $('.text-yellow-700').first().text(currentCount - 1);
          }
          
          // Check if table is empty
          if ($('#payoutTable tbody tr:visible').length === 0) {
            $('#payoutTable tbody').html(`
              <tr>
                <td colspan="10" class="text-center text-gray-500 py-8">
                  <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
                  <p class="font-medium">No pending payout requests</p>
                  <p class="text-xs mt-1">All requests have been processed!</p>
                </td>
              </tr>
            `);
          }
        });
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: data.error || 'Failed to update payout status'
      });
    }
  })
  .catch(function(error) {
    Swal.fire({
      icon: 'error',
      title: 'Error!',
      text: 'Network error. Please try again.'
    });
  });
}

$(document).ready(function() {
  // Initialize DataTable
  const table = $('#payoutTable').DataTable({
    pageLength: 25,
    order: [[7, 'desc']],
    responsive: true,
    language: {
      emptyTable: "No pending payout requests",
      info: "Showing _START_ to _END_ of _TOTAL_ requests",
      infoEmpty: "Showing 0 to 0 of 0 requests",
      infoFiltered: "(filtered from _MAX_ total requests)",
    },
    columnDefs: [
      { orderable: false, targets: [6, 8, 9] }
    ]
  });



  // Province filter
  $('#provinceFilter').on('change', function() {
    table.column(3).search(this.value).draw();
  });

  // Amount filter
  $('#amountFilter').on('change', function() {
    const value = this.value;
    if (value === '') {
      $.fn.dataTable.ext.search.pop();
    } else {
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        const amount = parseFloat($(table.row(dataIndex).node()).data('amount'));
        
        if (value === '0-5000') {
          return amount >= 0 && amount <= 5000;
        } else if (value === '5000-10000') {
          return amount > 5000 && amount <= 10000;
        } else if (value === '10000-50000') {
          return amount > 10000 && amount <= 50000;
        } else if (value === '50000+') {
          return amount > 50000;
        }
        return true;
      });
    }
    table.draw();
  });

  // Reset filters
  $('#resetBtn').on('click', function() {
    $(' #provinceFilter, #amountFilter').val('');
    $.fn.dataTable.ext.search.pop();
    table.search('').columns().search('').draw();
  });

  // Handle Status Change from dropdown
  $(document).on('change', '.status-select', function() {
    const requestId = $(this).data('request-id');
    const farmerName = $(this).data('farmer-name');
    const amount = $(this).data('amount');
    const newStatus = $(this).val();
    const $select = $(this);

    if (!newStatus) return;

    if (newStatus === 'approved') {
      Swal.fire({
        title: 'Approve Payout?',
        html: `Approve payout of <strong>Rs. ${parseFloat(amount).toFixed(2)}</strong> for <strong>${farmerName}</strong>?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, Approve'
      }).then((result) => {
        if (result.isConfirmed) {
          changePayoutStatus(requestId, 'approved', farmerName);
        } else {
          $select.val('');
        }
      });
    } else if (newStatus === 'rejected') {
      Swal.fire({
        title: 'Reject Payout',
        html: `Reject payout request for <strong>${farmerName}</strong>?`,
        input: 'textarea',
        inputLabel: 'Rejection Reason (Required)',
        inputPlaceholder: 'Enter reason for rejection...',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Reject',
        inputValidator: (value) => {
          if (!value) return 'Reason is required!';
          if (value.length < 10) return 'Please provide a detailed reason';
        }
      }).then((result) => {
        if (result.isConfirmed) {
          changePayoutStatus(requestId, 'rejected', farmerName, result.value);
        } else {
          $select.val('');
        }
      });
    } else if (newStatus === 'paid') {
      Swal.fire({
        title: 'Mark as Paid?',
        html: `Mark payout of <strong>Rs. ${parseFloat(amount).toFixed(2)}</strong> for <strong>${farmerName}</strong> as paid?<br><small class="text-gray-500">This confirms the payment has been completed.</small>`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#3b82f6',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, Mark as Paid'
      }).then((result) => {
        if (result.isConfirmed) {
          changePayoutStatus(requestId, 'paid', farmerName);
        } else {
          $select.val('');
        }
      });
    }
  });

  // Quick Approve Button
  $(document).on('click', '.approve-btn', function() {
    const requestId = $(this).data('request-id');
    const farmerName = $(this).data('farmer-name');
    const amount = $(this).data('amount');
    
    Swal.fire({
      title: 'Approve Payout?',
      html: `Approve payout of <strong>Rs. ${parseFloat(amount).toFixed(2)}</strong> for <strong>${farmerName}</strong>?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#10b981',
      cancelButtonColor: '#6b7280',
      confirmButtonText: 'Yes, Approve'
    }).then((result) => {
      if (result.isConfirmed) {
        changePayoutStatus(requestId, 'approved', farmerName);
      }
    });
  });

  // Quick Reject Button
  $(document).on('click', '.reject-btn', function() {
    const requestId = $(this).data('request-id');
    const farmerName = $(this).data('farmer-name');
    
    Swal.fire({
      title: 'Reject Payout',
      html: `Reject payout request for <strong>${farmerName}</strong>?`,
      input: 'textarea',
      inputLabel: 'Rejection Reason (Required)',
      inputPlaceholder: 'Enter detailed reason...',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#6b7280',
      confirmButtonText: 'Reject',
      inputValidator: (value) => {
        if (!value) return 'Reason is required!';
        if (value.length < 10) return 'Please provide detailed reason';
      }
    }).then((result) => {
      if (result.isConfirmed) {
        changePayoutStatus(requestId, 'rejected', farmerName, result.value);
      }
    });
  });

  // Close modal on ESC
  $(document).on('keydown', function(e) {
    if (e.key === 'Escape') {
      closeQRModal();
    }
  });

  // Close modal on background click
  $('#qrModal').on('click', function(e) {
    if (e.target.id === 'qrModal') {
      closeQRModal();
    }
  });
});
</script>
{% endblock %}
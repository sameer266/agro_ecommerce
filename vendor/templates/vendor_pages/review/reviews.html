{% extends 'components/base.html' %}
{% load static %}

{% block content %}
<div class="mb-6">
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800 mb-2 flex items-center gap-2">
        <i class="fas fa-star text-yellow-500"></i>
        Reviews & Ratings
      </h1>
      <p class="text-sm text-gray-500">Customer feedback and ratings for your products</p>
    </div>
  </div>
</div>

<!-- Statistics Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <!-- Total Reviews -->
  <div class="card bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">Total Reviews</p>
        <h3 class="text-2xl font-bold text-blue-700">{{ reviews.count }}</h3>
        <p class="text-xs text-gray-600">All time feedback</p>
      </div>
      <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
        <i class="fas fa-comments text-white text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Average Rating -->
  <div class="card bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">Average Rating</p>
        <h3 class="text-2xl font-bold text-yellow-700">
          {{average_rating}}
        </h3>
        <div class="flex gap-1 mt-1">
          <i class="fas fa-star text-yellow-500 text-xs"></i>
          <i class="fas fa-star text-yellow-500 text-xs"></i>
          <i class="fas fa-star text-yellow-500 text-xs"></i>
          <i class="fas fa-star text-yellow-500 text-xs"></i>
          <i class="fas fa-star text-gray-300 text-xs"></i>
        </div>
      </div>
      <div class="w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center">
        <i class="fas fa-star text-white text-xl"></i>
      </div>
    </div>
  </div>

  <!-- 5 Star Reviews -->
  <div class="card bg-gradient-to-br from-green-50 to-green-100 border-green-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">5 Star Reviews</p>
        <h3 class="text-2xl font-bold text-green-700">
          {{ five_star_count  }}
        </h3>
        <p class="text-xs text-gray-600">Excellent ratings</p>
      </div>
      <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
        <i class="fas fa-thumbs-up text-white text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Recent Reviews -->
  <div class="card bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1">This Month</p>
        <h3 class="text-2xl font-bold text-purple-700">
          {{monthly_reviews }}
        </h3>
        <p class="text-xs text-gray-600">New reviews</p>
      </div>
      <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
        <i class="fas fa-calendar-alt text-white text-xl"></i>
      </div>
    </div>
  </div>
</div>


<!-- Reviews Table -->
<div class="card">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide flex items-center gap-2">
      <i class="fas fa-list text-blue-600"></i>
      All Reviews
    </h3>
    {% if reviews %}
    <span class="text-xs text-gray-500">Total: {{ reviews.count }} reviews</span>
    {% endif %}
  </div>
  
  {% if reviews %}
  <div class="overflow-x-auto">
    <table id="reviewsTable" class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Product</th>
          <th>Customer</th>
          <th>Rating</th>
          <th>Review</th>
          <th>Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for review in reviews %}
        <tr data-rating="{{ review.rating }}">
          <td class="font-medium text-primary">#{{ review.id }}</td>
          
          <!-- Product -->
          <td>
            <div class="flex items-center gap-3">
              {% if review.vendor_product.farmer_product.image %}
              <img src="{{ review.vendor_product.farmer_product.image.url }}" alt="{{ review.vendor_product.farmer_product.name }}" class="w-10 h-10 object-cover rounded">
              {% else %}
              <div class="w-10 h-10 bg-gray-200 rounded flex items-center justify-center">
                <i class="fas fa-image text-gray-400 text-sm"></i>
              </div>
              {% endif %}
              <div>
                <div class="font-medium text-gray-800">{{ review.vendor_product.farmer_product.name }}</div>
                <div class="text-xs text-gray-500">{{ review.vendor_product.farmer_product.category.name|default:"Uncategorized" }}</div>
              </div>
            </div>
          </td>
          
          <!-- Customer -->
          <td>
            <div class="font-medium text-gray-700">{{ review.user.get_full_name|default:review.user.username }}</div>
            <div class="text-xs text-gray-500">{{ review.user.email }}</div>
          </td>
          
          <!-- Rating -->
          <td>
            <div class="flex items-center gap-2">
              <div class="flex gap-0.5">
                {% for i in "12345" %}
                  {% if forloop.counter <= review.rating %}
                    <i class="fas fa-star text-yellow-500 text-sm"></i>
                  {% else %}
                    <i class="far fa-star text-gray-300 text-sm"></i>
                  {% endif %}
                {% endfor %}
              </div>
              <span class="text-sm font-semibold text-gray-700">{{ review.rating }}/5</span>
            </div>
            {% if review.rating >= 4 %}
            <span class="text-xs text-green-600 font-medium mt-1 block">
              <i class="fas fa-thumbs-up"></i> Positive
            </span>
            {% elif review.rating >= 3 %}
            <span class="text-xs text-yellow-600 font-medium mt-1 block">
              <i class="fas fa-minus-circle"></i> Neutral
            </span>
            {% else %}
            <span class="text-xs text-red-600 font-medium mt-1 block">
              <i class="fas fa-thumbs-down"></i> Negative
            </span>
            {% endif %}
          </td>
          
          <!-- Review Comment -->
          <td>
            {% if review.comment %}
            <div class="text-sm text-gray-700 max-w-md">
              <p class="line-clamp-2">"{{ review.comment }}"</p>
            </div>
            {% else %}
            <span class="text-xs text-gray-400 italic">No comment provided</span>
            {% endif %}
          </td>
          
          <!-- Date -->
          <td>
            <div class="text-sm text-gray-700">{{ review.created_at|date:"M d, Y" }}</div>
            <div class="text-xs text-gray-500">{{ review.created_at|time:"H:i" }}</div>
            <div class="text-xs text-gray-400 mt-1">{{ review.created_at|timesince }} ago</div>
          </td>
          
          <!-- Status -->
          <td>
            {% if review.rating >= 4 %}
            <span class="badge badge-success">
              <i class="fas fa-check-circle"></i> Verified
            </span>
            {% elif review.rating >= 3 %}
            <span class="badge badge-warning">
              <i class="fas fa-exclamation-circle"></i> Verified
            </span>
            {% else %}
            <span class="badge badge-danger">
              <i class="fas fa-flag"></i> Needs Attention
            </span>
            {% endif %}
          </td>
          
          <!-- Actions -->
          <td>
            <div class="flex gap-2">
              <button class="btn btn-info btn-sm" title="View Full Review" onclick="viewReview({{ review.id }})">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-secondary btn-sm" title="Reply" onclick="replyReview({{ review.id }})">
                <i class="fas fa-reply"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="text-center py-12 text-gray-500">
    <i class="fas fa-star text-5xl mb-3 text-gray-300"></i>
    <p class="font-medium text-lg">No reviews yet</p>
    <p class="text-sm text-gray-400 mt-1">Customer reviews will appear here once they purchase and rate your products</p>
  </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
  // Initialize DataTable with search enabled (if table exists)
  if ($('#reviewsTable').length) {
    $('#reviewsTable').DataTable({
      pageLength: 25,
      order: [[5, 'desc']], // Sort by date
      responsive: true,
      searching: true, // Enable search
      language: {
        emptyTable: "No reviews found",
        info: "Showing _START_ to _END_ of _TOTAL_ reviews",
        infoEmpty: "Showing 0 to 0 of 0 reviews",
        infoFiltered: "(filtered from _MAX_ total reviews)",
        search: "Search:",
        searchPlaceholder: "Search reviews..."
      },
      columnDefs: [
        { orderable: false, targets: [7] } // Disable sorting for actions
      ]
    });
  }
});

// View review modal/detail
function viewReview(reviewId) {
  alert('View review detail feature - Review ID: ' + reviewId);
  // Implement modal or redirect to detail page
}

// Reply to review
function replyReview(reviewId) {
  alert('Reply to review feature - Review ID: ' + reviewId);
  // Implement reply modal or form
}
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
{% endblock %}